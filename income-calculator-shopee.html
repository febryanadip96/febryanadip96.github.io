<!DOCTYPE html>
<html>

<head>
    <title>Income Statement</title>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css'>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src='https://code.jquery.com/jquery-3.2.1.slim.min.js'
        integrity='sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN'
        crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'
        integrity='sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q'
        crossorigin='anonymous'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js'></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.8/css/fixedHeader.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.1.8/js/dataTables.fixedHeader.min.js"></script>

</head>

<body style='padding-top: 20px;'>
    <div class='container'>
        <h2 class='text-center'><i class="fa fa-calculator"></i> JH Income Calculator Shopee <i class="fa fa-calculator"></i></h2>
        <br/>
        <div class='row'>
            <div class='col-sm-12'>
                <form id='form-update-stock'>
                    
                    <div class='form-group'>
                        <label>Excel Penghasilan Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='penghasilan-excel' name='stock-excel' />
                    </div>

                    <div class='row'>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pesanan-penghasilan' name='baris-awal-pesanan-penghasilan' value="7"/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom No Pesanan</label>
                                <input type='number' class='form-control' id='kolom-no-pesanan-penghasilan' name='kolom-no-pesanan-penghasilan' value="2"/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Penghasilan</label>
                                <input type='number' class='form-control' id='kolom-penghasilan-penghasilan' name='kolom-penghasilan-penghasilan' value="22"/>
                            </div>
                        </div>
                    </div>

                    <div class='form-group'>
                        <label>Excel Pesanan Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='pesanan-excel' name='pesanan-excel' />
                    </div>

                    <div class='row'>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pesanan-pesanan' name='baris-awal-pesanan-pesanan' value="2"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom No Pesanan</label>
                                <input type='number' class='form-control' id='kolom-no-pesanan-pesanan' name='kolom-no-pesanan-pesanan' value="1"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Nama Barang</label>
                                <input type='number' class='form-control' id='kolom-nama-barang-pesanan' name='kolom-nama-barang-pesanan' value="12"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Nama Varian</label>
                                <input type='number' class='form-control' id='kolom-nama-varian-pesanan' name='kolom-nama-varian-pesanan' value="14"/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Jumlah Barang</label>
                                <input type='number' class='form-control' id='kolom-jumlah-barang-pesanan' name='kolom-jumlah-barang-pesanan' value="17"/>
                            </div>
                        </div>
                    </div>

                    <div class='form-group'>
                        <label>Excel Pricelist Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='pricelist-excel' name='pricelist-excel' />
                    </div>

                    <div class='row'>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pricelist' name='baris-awal-pricelist' value="3"/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Nama Barang</label>
                                <input type='number' class='form-control' id='kolom-nama-barang-pricelist' name='kolom-nama-barang-pricelist' value="2"/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Harga Modal</label>
                                <input type='number' class='form-control' id='kolom-harga-modal-pricelist' name='kolom-harga-modal-pricelist' value="3"/>
                            </div>
                        </div>
                    </div>

                    <button type='submit' id="submit-input" class='btn btn-outline-primary btn-block'>
                        Proses
                    </button>

                    
                    <div class='form-group'>
                        <label>Total Untung</label>
                        <input type='text' class='form-control' id='total-untung' name='total-untung' readonly/>
                    </div>
                </form>
            </div>
        </div>
        <br />
        <button class="btn btn-sm btn-link float-right" data-toggle="popover" title="Info" data-html="true" data-content="Jika kolom nama barang kosong -> Tidak ditemukan data referensi di excel pesanan<br><br>
        Jika kolom modal kosong  -> Tidak ditemukan data referensi di excel pricelist"><i class="fa fa-info"></i></button>
        <div>
            <table id='table' class='table table-striped table-bordered' style='width:100%'>
                <thead>
                    <tr>
                    <th>No Pesanan</th>
                    <th>Nama Barang</th>
                    <th>Modal</th>
                    <th>Penjualan</th>
                    <th>Untung</th>
                </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>

        <div><h3></h3></div>
        <div><h3></h3></div>
        <footer>
            <p style='color:#007BFF; text-align: end;'>Created by The Febryan Adi Prayitno @2021 ðŸ˜€</p>
        </footer>
    </div>

    <script>
        $(function () {

            var filePenghasilan = null;
            var filePesanan = null;
            var filePricelist = null;

            var stringPenghasilan = null;
            var stringPesanan = null;
            var stringPricelist = null;

            //Delete in pricelist
            var exclude_in_pricelist = [
                'promo',
                '\ud83c[\udf00-\udfff]', // U+1F300 to U+1F3FF
                '\ud83d[\udc00-\ude4f]', // U+1F400 to U+1F64F
                '\ud83d[\ude80-\udeff]',  // U+1F680 to U+1F6FF
                '[^\x00-\x7F]', // non-ascii
                '[{()}]' //close parenthesis
            ];

            //statis variable
            var barisAwalPesananDiPenghasilan = parseInt($('#baris-awal-pesanan-penghasilan').val()? $('#baris-awal-pesanan-penghasilan').val()-1 : 6);
            var kolomNoPesananDiPenghasilan = parseInt($('#kolom-no-pesanan-penghasilan').val()? $('#kolom-no-pesanan-penghasilan').val()-1 : 1);
            var kolomPenghasilanDiPenghasilan = parseInt($('#kolom-penghasilan-penghasilan').val()? $('#kolom-penghasilan-penghasilan').val()-1 : 21);

            var barisAwalPesananDiPesanan = parseInt($('#baris-awal-pesanan-pesanan').val()? $('#baris-awal-pesanan-pesanan').val()-1 : 1);
            var kolomNoPesananDiPesanan = parseInt($('#kolom-no-pesanan-pesanan').val()? $('#kolom-no-pesanan-pesanan').val()-1 : 0);
            var kolomNamaBarangDiPesanan = parseInt($('#kolom-nama-barang-pesanan').val()? $('#kolom-nama-barang-pesanan').val()-1 : 11);
            var kolomNamaVarianDiPesanan = parseInt($('#kolom-nama-varian-pesanan').val()? $('#kolom-nama-varian-pesanan').val()-1 : 13);
            var kolomJumlahBarangDiPesanan = parseInt($('#kolom-jumlah-barang-pesanan').val()? $('#kolom-jumlah-barang-pesanan').val()-1 : 16);

            var barisAwalPriceDiPricelist = parseInt($('#baris-awal-pricelist').val()? $('#baris-awal-pricelist').val()-1 :2);
            var kolomNamaBarangDiPricelist = parseInt($('#kolom-nama-barang-pricelist').val()? $('#kolom-nama-barang-pricelist').val()-1 :1);
            var kolomHargaModalDiPricelist = parseInt($('#kolom-harga-modal-pricelist').val()? $('#kolom-harga-modal-pricelist').val()-1 :2);

            var table = $('#table').DataTable({
                paging:false,
                fixedHeader: true
            });

            $('[data-toggle="popover"]').popover();

            $('#form-update-stock').submit(function (e) {
                e.preventDefault();
            });


            $('#submit-input').on('click', function(){

                filePenghasilan = null;
                filePesanan = null;
                filePricelist = null;

                stringPenghasilan = null;
                stringPesanan = null;
                stringPricelist = null;

                filePenghasilan = $('#penghasilan-excel').prop('files')[0];
                filePesanan = $('#pesanan-excel').prop('files')[0];
                filePricelist = $('#pricelist-excel').prop('files')[0];

                if (typeof filePenghasilan == 'undefined') {
                    alert('Harap masukkan CSV Penghasilan');
                    return;
                }
                if (typeof filePesanan == 'undefined') {
                    alert('Harap masukkan CSV Pesanan');
                    return;
                }
                if (typeof filePricelist == 'undefined') {
                    alert('Harap masukkan CSV Pricelist');
                    return;
                }

                processOne();
            });

            function processOne(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPenghasilan = fileReader.result;
                    processTwo();
                };
                fileReader.readAsText(filePenghasilan);
            }

            function processTwo(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPesanan = fileReader.result;
                    processThree();
                };
                fileReader.readAsText(filePesanan);
            }

            function processThree(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPricelist = fileReader.result;
                    mainProcess();
                };
                fileReader.readAsText(filePricelist);
            }

            function mainProcess(){

                table.clear().draw();

                try{

                    stringPricelist = stringPricelist.toLowerCase().replace(new RegExp(exclude_in_pricelist.join('|'), 'g'), '')

                    var array_pesanan = stringPesanan.split('\n');
                    var array_penghasilan = stringPenghasilan.split('\n');
                    var array_pricelist = stringPricelist.split('\n');

                    var total_modal = 0;
                    var total_penghasilan = 0;
                    var untung = 0;
                    var total_untung = 0;

                    for (var i = barisAwalPesananDiPenghasilan; i < array_penghasilan.length; i++) {
                        var data_penghasilan = array_penghasilan[i].split(',');
                        var no_pesanan = data_penghasilan[kolomNoPesananDiPenghasilan];

                        if(typeof no_pesanan == 'undefined') break;

                        total_penghasilan = parseInt(data_penghasilan[kolomPenghasilanDiPenghasilan]);

                        var nama_barang_dan_jumlah = '';

                        var text_harga_barang = '';

                        untung = 0;

                        total_modal = 0;

                        for(var j = barisAwalPesananDiPesanan; j < array_pesanan.length; j++){

                            if(array_pesanan[j].match(new RegExp('\\b'+no_pesanan+'\\b', 'g'))!=null){

                                var data_pesanan = array_pesanan[j].split(',');

                                nama_barang_dan_jumlah += data_pesanan[kolomNamaBarangDiPesanan] +' <b>' +data_pesanan[kolomJumlahBarangDiPesanan]+'x</b><br>';

                                var nama_barang_to_check = data_pesanan[kolomNamaBarangDiPesanan].toLowerCase();

                                var harga_barang = 0;

                                for(var h = barisAwalPriceDiPricelist; h < array_pricelist.length; h++){

                                    var data_pricelist = array_pricelist[h].split(',');

                                    var ada = true;

                                    var array_nama_barang_pricelist = String(data_pricelist[kolomNamaBarangDiPricelist]).trim().toLowerCase().split(' ');

                                    for (var k = 0; k < array_nama_barang_pricelist.length; k++) {

                                        if (nama_barang_to_check.match(new RegExp('\\b'+String(array_nama_barang_pricelist[k]).trim()+'\\b', 'g'))==null) {//Find a match at the beginning/end of a word
                                            ada = false;
                                        }

                                    }

                                    if(ada){
                                        harga_barang += parseInt(data_pesanan[kolomJumlahBarangDiPesanan])*parseInt(data_pricelist[kolomHargaModalDiPricelist]);
                                        
                                        if(Number.isNaN(harga_barang)) harga_barang = 0;

                                        text_harga_barang += harga_barang+ "<br>";

                                        total_modal += harga_barang;
                                        break;
                                    }
                                }
                            }
                        }

                        text_harga_barang += '(<b>'+total_modal+'</b>)'

                        untung = total_penghasilan - total_modal;
                        total_untung += untung;

                        table.row.add([
                            no_pesanan,
                            nama_barang_dan_jumlah,
                            text_harga_barang,
                            total_penghasilan,
                            untung
                        ]).draw( false );
                    }

                    $('#total-untung').val(total_untung);
                }
                catch(err){
                    alert(err);
                }
                
            }
        });   
    </script>
</body>

</html>