<!DOCTYPE html>
<html>

<head>
    <title>Income Statement</title>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css'>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'
        integrity='sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q'
        crossorigin='anonymous'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js'></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.8/css/fixedHeader.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.1.8/js/dataTables.fixedHeader.min.js"></script>

</head>

<body style='padding-top: 20px;'>
    <div class='container'>
        <h2 class='text-center'><i class="fa fa-calculator"></i> JH Income Calculator Shopee <i class="fa fa-calculator"></i></h2>
        <br/>
        <div class='row'>
            <div class='col-sm-12'>
                <form id='form-update-stock'>
                    
                    <div class='form-group'>
                        <label>Excel Penghasilan Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='penghasilan-excel' name='stock-excel' />
                    </div>

                    <div class='row'>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pesanan-penghasilan' name='baris-awal-pesanan-penghasilan'/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom No Pesanan</label>
                                <input type='number' class='form-control' id='kolom-no-pesanan-penghasilan' name='kolom-no-pesanan-penghasilan'/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Penghasilan</label>
                                <input type='number' class='form-control' id='kolom-penghasilan-penghasilan' name='kolom-penghasilan-penghasilan'/>
                            </div>
                        </div>
                    </div>

                    <div class='form-group'>
                        <label>Excel Pesanan Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='pesanan-excel' name='pesanan-excel' />
                    </div>

                    <div class='row'>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pesanan-pesanan' name='baris-awal-pesanan-pesanan'/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom No Pesanan</label>
                                <input type='number' class='form-control' id='kolom-no-pesanan-pesanan' name='kolom-no-pesanan-pesanan'/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Nama Barang</label>
                                <input type='number' class='form-control' id='kolom-nama-barang-pesanan' name='kolom-nama-barang-pesanan'/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Nama Varian</label>
                                <input type='number' class='form-control' id='kolom-nama-varian-pesanan' name='kolom-nama-varian-pesanan'/>
                            </div>
                        </div>
                        <div class="col-sm-2">
                            <div class='form-group'>
                                <label>Kolom Jumlah Barang</label>
                                <input type='number' class='form-control' id='kolom-jumlah-barang-pesanan' name='kolom-jumlah-barang-pesanan'/>
                            </div>
                        </div>
                    </div>

                    <div class='form-group'>
                        <label>Excel Pricelist Shopee (format csv)</label>
                        <input type='file' class='form-control-file' id='pricelist-excel' name='pricelist-excel' />
                        <span class="badge badge-warning">Pastikan harga barang tidak mengandung tanda "," (koma)</span>
                    </div>

                    <div class='row'>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Baris Awal Data</label>
                                <input type='number' class='form-control' id='baris-awal-pricelist' name='baris-awal-pricelist'/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Nama Barang</label>
                                <input type='number' class='form-control' id='kolom-nama-barang-pricelist' name='kolom-nama-barang-pricelist'/>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class='form-group'>
                                <label>Kolom Harga Modal</label>
                                <input type='number' class='form-control' id='kolom-harga-modal-pricelist' name='kolom-harga-modal-pricelist'/>
                            </div>
                        </div>
                    </div>

                    <button type='submit' id="submit-input" class='btn btn-outline-primary btn-block'>
                        <span id="loading" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        Proses
                    </button>

                    

                    
                    <div class='form-group'>
                        <label>Total Untung</label>
                        <input type='text' class='form-control' id='total-untung' name='total-untung' readonly/>
                    </div>
                </form>
            </div>
        </div>

        <br />
        <button class="btn btn-md btn-link float-left" data-toggle="popover" title="Info" data-html="true" data-content="<b>Kolom nama barang kosong.</b> Alasan : data pesanan di excel pesanan tidak lengkap (perlu ambil data pesanan terdahulu/1 bulan sebelumnya)<br><br>
        <b>Kolom modal kosong/nol.</b> Alasan : nama barang di pricelist tidak sama/mirip dengan nama barang di excel pesanan<br><br><b>Masalah lainnya.</b> Alasan : setting baris/kolom salah atau kesalahan pada data"><i class="fa fa-info"></i>&nbsp;&nbspKlik di sini jika ada kendala hasil di tabel</button>
        <div>
            <table id='table' class='table table-striped table-bordered' style='width:100%'>
                <thead>
                    <tr>
                    <th>No Pesanan</th>
                    <th>Nama Barang</th>
                    <th>Modal</th>
                    <th>Penjualan</th>
                    <th>Untung</th>
                </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>

        <div><h3></h3></div>
        <div><h3></h3></div>
        <footer>
            <p style='color:#007BFF; text-align: end;'>Created by The Febryan Adi Prayitno @2021 ðŸ˜€</p>
        </footer>
    </div>

    <script>
        $(function () {

            //get variable
            var barisAwalPesananDiPenghasilan = 6;
            var kolomNoPesananDiPenghasilan = 1;
            var kolomPenghasilanDiPenghasilan = 21;

            var barisAwalPesananDiPesanan = 1;
            var kolomNoPesananDiPesanan = 0;
            var kolomNamaBarangDiPesanan = 12;
            var kolomNamaVarianDiPesanan = 14;
            var kolomJumlahBarangDiPesanan = 17;

            var barisAwalPriceDiPricelist = 2;
            var kolomNamaBarangDiPricelist = 1;
            var kolomHargaModalDiPricelist = 2;

            $('#baris-awal-pesanan-penghasilan').val(barisAwalPesananDiPenghasilan+1);
            $('#kolom-no-pesanan-penghasilan').val(kolomNoPesananDiPenghasilan+1);
            $('#kolom-penghasilan-penghasilan').val(kolomPenghasilanDiPenghasilan+1);

            $('#baris-awal-pesanan-pesanan').val(barisAwalPesananDiPesanan+1);
            $('#kolom-no-pesanan-pesanan').val(kolomNoPesananDiPesanan+1);
            $('#kolom-nama-barang-pesanan').val(kolomNamaBarangDiPesanan+1);
            $('#kolom-nama-varian-pesanan').val(kolomNamaVarianDiPesanan+1);
            $('#kolom-jumlah-barang-pesanan').val(kolomJumlahBarangDiPesanan+1);

            $('#baris-awal-pricelist').val(barisAwalPriceDiPricelist+1);
            $('#kolom-nama-barang-pricelist').val(kolomNamaBarangDiPricelist+1);
            $('#kolom-harga-modal-pricelist').val(kolomHargaModalDiPricelist+1);


            var filePenghasilan = null;
            var filePesanan = null;
            var filePricelist = null;

            var stringPenghasilan = null;
            var stringPesanan = null;
            var stringPricelist = null;

            //Delete in pricelist
            var exclude_in_pricelist = [
                'promo',
                '\ud83c[\udf00-\udfff]', // U+1F300 to U+1F3FF
                '\ud83d[\udc00-\ude4f]', // U+1F400 to U+1F64F
                '\ud83d[\ude80-\udeff]',  // U+1F680 to U+1F6FF
                '[^\x00-\x7F]', // non-ascii
                '[{()}]' //close parenthesis
            ];

            var table = $('#table').DataTable({
                fixedHeader: true
            });

            $('[data-toggle="popover"]').popover();

            $('#form-update-stock').submit(function (e) {
                e.preventDefault();
            });


            $('#submit-input').on('click', function(){

                filePenghasilan = null;
                filePesanan = null;
                filePricelist = null;

                stringPenghasilan = null;
                stringPesanan = null;
                stringPricelist = null;

                filePenghasilan = $('#penghasilan-excel').prop('files')[0];
                filePesanan = $('#pesanan-excel').prop('files')[0];
                filePricelist = $('#pricelist-excel').prop('files')[0];

                if (typeof filePenghasilan == 'undefined') {
                    alert('Harap masukkan CSV Penghasilan');
                    return;
                }
                if (typeof filePesanan == 'undefined') {
                    alert('Harap masukkan CSV Pesanan');
                    return;
                }
                if (typeof filePricelist == 'undefined') {
                    alert('Harap masukkan CSV Pricelist');
                    return;
                }

                processOne();
            });

            function processOne(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPenghasilan = fileReader.result;
                    processTwo();
                };
                fileReader.readAsText(filePenghasilan);
            }

            function processTwo(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPesanan = fileReader.result;
                    processThree();
                };
                fileReader.readAsText(filePesanan);
            }

            function processThree(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPricelist = fileReader.result;
                    mainProcess();
                };
                fileReader.readAsText(filePricelist);
            }

            function mainProcess(){

                //get variable
                if($('#baris-awal-pesanan-penghasilan').val()) barisAwalPesananDiPenghasilan = parseInt($('#baris-awal-pesanan-penghasilan').val() - 1);
                if($('#kolom-no-pesanan-penghasilan').val()) kolomNoPesananDiPenghasilan = parseInt($('#kolom-no-pesanan-penghasilan').val() - 1);
                if($('#kolom-penghasilan-penghasilan').val()) kolomPenghasilanDiPenghasilan = parseInt($('#kolom-penghasilan-penghasilan').val() - 1);

                if($('#baris-awal-pesanan-pesanan').val()) barisAwalPesananDiPesanan = parseInt($('#baris-awal-pesanan-pesanan').val() -1);
                if($('#kolom-no-pesanan-pesanan').val()) kolomNoPesananDiPesanan = parseInt($('#kolom-no-pesanan-pesanan').val() -1);
                if($('#kolom-nama-barang-pesanan').val())  kolomNamaBarangDiPesanan = parseInt($('#kolom-nama-barang-pesanan').val()-1);
                if($('#kolom-nama-varian-pesanan').val()) kolomNamaVarianDiPesanan = parseInt($('#kolom-nama-varian-pesanan').val() -1);
                if($('#kolom-jumlah-barang-pesanan').val()) kolomJumlahBarangDiPesanan = parseInt($('#kolom-jumlah-barang-pesanan').val()-1);

                if($('#baris-awal-pricelist').val())  barisAwalPriceDiPricelist = (parseInt($('#baris-awal-pricelist').val()-1));
                if($('#kolom-nama-barang-pricelist').val()) kolomNamaBarangDiPricelist = parseInt($('#kolom-nama-barang-pricelist').val()-1 );
                if($('#kolom-harga-modal-pricelist').val()) kolomHargaModalDiPricelist = parseInt($('#kolom-harga-modal-pricelist').val()-1 );


                table.clear().draw();

                stringPricelist = stringPricelist.toLowerCase().replace(new RegExp(exclude_in_pricelist.join('|'), 'g'), '');

                
                $('#loading').removeClass('d-none');

                $.ajax({
                    type : "POST",
                    url : 'backend-income-calculator-shopee.php',
                    data : {barisAwalPesananDiPenghasilan, kolomNoPesananDiPenghasilan, kolomPenghasilanDiPenghasilan,
                        barisAwalPesananDiPesanan, kolomNoPesananDiPesanan, kolomNamaBarangDiPesanan, kolomNamaVarianDiPesanan, kolomJumlahBarangDiPesanan,
                        barisAwalPriceDiPricelist, kolomNamaBarangDiPricelist, kolomHargaModalDiPricelist,
                        stringPesanan, stringPenghasilan, stringPricelist},
                    success: function(data) {
                        var object = JSON.parse(data);

                        var data_table = object['data_table'];
                        for (var i = 0; i < data_table.length; i++) {
                            table.row.add([
                                data_table[i][0],
                                data_table[i][1],
                                data_table[i][2],
                                data_table[i][3],
                                data_table[i][4]
                            ]).draw( false );
                        }

                        $('#total-untung').val(object['total_untung']);
                        
                        $('#loading').addClass('d-none'); 
                    }
                });
            }
        });
    </script>
</body>

</html>