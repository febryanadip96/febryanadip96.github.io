<!DOCTYPE html>
<html>

<head>
    <title>Income Statement</title>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css'
        integrity='sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm' crossorigin='anonymous'>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src='https://code.jquery.com/jquery-3.2.1.slim.min.js'
        integrity='sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN'
        crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js'
        integrity='sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q'
        crossorigin='anonymous'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js'
        integrity='sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl'
        crossorigin='anonymous'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js'></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.8/css/fixedHeader.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.1.8/js/dataTables.fixedHeader.min.js"></script>

</head>

<body style='padding-top: 20px;'>
    <div class='container'>
        <h2 class='text-center'>ðŸ“¦ JH Income Calculator Shopee ðŸ“¦</h2>
        <br/>
        <div class='row'>
            <div class='col-sm-12'>
                <form id='form-update-stock'>
                    
                    <div class='form-group'>
                        <label>Excel Penghasilan Shopee (format csv)</label>
                        <input type='file' class='form-control' id='penghasilan-excel' name='stock-excel' />
                    </div>

                    <div class='form-group'>
                        <label>Excel Pesanan Shopee (format csv)</label>
                        <input type='file' class='form-control' id='pesanan-excel' name='stock-excel' />
                    </div>

                    <div class='form-group'>
                        <label>Excel Pricelist Shopee (format csv)</label>
                        <input type='file' class='form-control' id='pricelist-excel' name='stock-excel' />
                    </div>

                    <button type='submit' id="submit-input" class='btn btn-outline-primary btn-block'>Proses</button>

                    
                    <div class='form-group'>
                        <label>Total Untung</label>
                        <input type='text' class='form-control' id='total-untung' name='total-untung' readonly/>
                    </div>
                </form>
            </div>
        </div>
        <br />
        <button class="btn btn-sm btn-link float-right" data-toggle="popover" title="Info" data-html="true" data-content="Jika kolom nama barang kosong -> Tidak ditemukan data referensi di excel pesanan<br><br>
        Jika kolom modal kosong  -> Tidak ditemukan data referensi di excel pricelist"><i class="fa fa-info"></i></button>
        <div>
            <table id='table' class='table table-striped table-bordered' style='width:100%'>
                <thead>
                    <tr>
                    <th>No Pesanan</th>
                    <th>Nama Barang</th>
                    <th>Modal</th>
                    <th>Penjualan</th>
                    <th>Untung</th>
                </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>

        <div><h3></h3></div>
        <div><h3></h3></div>
        <footer>
            <p style='color:#007BFF; text-align: end;'>Created by The Febryan Adi Prayitno @2021 ðŸ˜€</p>
        </footer>
    </div>

    <script>
        $(function () {

            var filePenghasilan = null;
            var filePesanan = null;
            var filePricelist = null;

            var stringPenghasilan = null;
            var stringPesanan = null;
            var stringPricelist = null;

            //Delete in pricelist
            var exclude_in_pricelist = [
                'promo',
                '\ud83c[\udf00-\udfff]', // U+1F300 to U+1F3FF
                '\ud83d[\udc00-\ude4f]', // U+1F400 to U+1F64F
                '\ud83d[\ude80-\udeff]',  // U+1F680 to U+1F6FF
                '[^\x00-\x7F]', // non-ascii
                '[{()}]' //close parenthesis
            ];

            //statis variable
            var barisAwalPesananDiPenghasilan = 6;
            var kolomNoPesananDiPenghasilan = 1;
            var kolomPenghasilanDiPenghasilan = 20;

            var barisAwalPesananDiPesanan = 1;
            var kolomNoPesananDiPesanan = 0;
            var kolomNamaBarangDiPesanan = 12;
            var kolomNamaVarianDiPesanan = 14;
            var kolomJumlahBarangDiPesanan = 17;

            var barisAwalPriceDiPricelist = 3;
            var kolomNamaBarangDiPricelist = 2;
            var kolomHargaModalDiPricelist = 11;

            var table = $('#table').DataTable({
                paging:false,
                fixedHeader: true
            });

            $('[data-toggle="popover"]').popover();

            $('#form-update-stock').submit(function (e) {
                e.preventDefault();
            });


            $('#submit-input').on('click', function(){

                filePenghasilan = null;
                filePesanan = null;
                filePricelist = null;

                stringPenghasilan = null;
                stringPesanan = null;
                stringPricelist = null;

                filePenghasilan = $('#penghasilan-excel').prop('files')[0];
                filePesanan = $('#pesanan-excel').prop('files')[0];
                filePricelist = $('#pricelist-excel').prop('files')[0];

                if (typeof filePenghasilan == 'undefined') {
                    alert('Harap masukkan CSV Penghasilan');
                    return;
                }
                if (typeof filePesanan == 'undefined') {
                    alert('Harap masukkan CSV Pesanan');
                    return;
                }
                if (typeof filePricelist == 'undefined') {
                    alert('Harap masukkan CSV Pricelist');
                    return;
                }

                processOne();
            });

            function processOne(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPenghasilan = fileReader.result;
                    processTwo();
                };
                fileReader.readAsText(filePenghasilan);
            }

            function processTwo(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPesanan = fileReader.result;
                    processThree();
                };
                fileReader.readAsText(filePesanan);
            }

            function processThree(){
                var fileReader = new FileReader();
                fileReader.onload = function () {
                    stringPricelist = fileReader.result;
                    mainProcess();
                };
                fileReader.readAsText(filePricelist);
            }

            function mainProcess(){

                stringPricelist = stringPricelist.toLowerCase().replace(new RegExp(exclude_in_pricelist.join('|'), 'g'), '')


                var array_pesanan = stringPesanan.split('\n');
                var array_penghasilan = stringPenghasilan.split('\n');
                var array_pricelist = stringPricelist.split('\n');

                var total_modal = 0;
                var total_penghasilan = 0;
                var untung = 0;
                var total_untung = 0;

                for (var i = barisAwalPesananDiPenghasilan; i < array_penghasilan.length; i++) {
                    var data_penghasilan = array_penghasilan[i].split(',');
                    var no_pesanan = data_penghasilan[kolomNoPesananDiPenghasilan];

                    if(typeof no_pesanan == 'undefined') break;

                    total_penghasilan = parseInt(data_penghasilan[kolomPenghasilanDiPenghasilan]);

                    var nama_barang_dan_jumlah = '';

                    var text_harga_barang = '';

                    untung = 0;

                    total_modal = 0;

                    for(var j = barisAwalPesananDiPesanan; j < array_pesanan.length; j++){

                        if(array_pesanan[j].match(new RegExp('\\b'+no_pesanan+'\\b', 'g'))!=null){

                            var data_pesanan = array_pesanan[j].split(',');

                            nama_barang_dan_jumlah += data_pesanan[kolomNamaBarangDiPesanan] +' <b>' +data_pesanan[kolomJumlahBarangDiPesanan]+'x</b><br>';

                            var nama_barang_to_check = data_pesanan[kolomNamaBarangDiPesanan].toLowerCase();

                            var harga_barang = 0;

                            for(var h = barisAwalPriceDiPricelist; h < array_pricelist.length; h++){

                                var data_pricelist = array_pricelist[h].split(',');

                                var ada = true;

                                var array_nama_barang_pricelist = String(data_pricelist[kolomNamaBarangDiPricelist]).trim().toLowerCase().split(' ');

                                for (var k = 0; k < array_nama_barang_pricelist.length; k++) {

                                    if (nama_barang_to_check.match(new RegExp('\\b'+String(array_nama_barang_pricelist[k]).trim()+'\\b', 'g'))==null) {//Find a match at the beginning/end of a word
                                        ada = false;
                                    }

                                }

                                if(ada){
                                    harga_barang += parseInt(data_pesanan[kolomJumlahBarangDiPesanan])*parseInt(data_pricelist[kolomHargaModalDiPricelist]);
                                    
                                    if(Number.isNaN(harga_barang)) harga_barang = 0;

                                    text_harga_barang += harga_barang+ "<br>";

                                    total_modal += harga_barang;
                                    break;
                                }
                            }
                        }
                    }

                    text_harga_barang += '(<b>'+total_modal+'</b>)'

                    untung = total_penghasilan - total_modal;
                    total_untung += untung;

                    table.row.add([
                        no_pesanan,
                        nama_barang_dan_jumlah,
                        text_harga_barang,
                        total_penghasilan,
                        untung
                    ]).draw( false );
                }

                $('#total-untung').val(total_untung);
            }
        });   
    </script>
</body>

</html>